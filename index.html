// تابع جدید برای دریافت و پردازش کانفیگ‌های V2Ray
async function fetchRealV2RayConfigs() {
    try {
        // استفاده از CORS proxy برای دور زدن محدودیت‌های گیتهاب
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const targetUrl = 'https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt';
        
        showNotification(language === 'fa' ? 'در حال دریافت کانفیگ‌ها...' : 'Fetching configs...');
        
        const response = await fetch(proxyUrl + targetUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) {
            throw new Error(language === 'fa' ? 'خطا در دریافت فایل از گیتهاب' : 'Failed to fetch from GitHub');
        }
        
        const text = await response.text();
        v2rayConfigs = parseV2RayConfigs(text);
        
        if (v2rayConfigs.length === 0) {
            throw new Error(language === 'fa' ? 'هیچ کانفیگی یافت نشد' : 'No configs found');
        }
        
        renderV2RayConfigs();
        showNotification(language === 'fa' ? 
            `${v2rayConfigs.length} کانفیگ با موفقیت لود شد` : 
            `${v2rayConfigs.length} configs loaded successfully`);
            
    } catch (error) {
        console.error('Error fetching V2Ray configs:', error);
        showNotification(language === 'fa' ? 
            'خطا در دریافت کانفیگ‌ها. لطفا از VPN استفاده کنید.' : 
            'Error fetching configs. Please use VPN.');
        
        // استفاده از داده‌های نمونه به عنوان جایگزین
        v2rayConfigs = sampleV2RayConfigs;
        renderV2RayConfigs();
    }
}

// تابع پردازش فایل متنی و استخراج کانفیگ‌ها
function parseV2RayConfigs(text) {
    const configs = [];
    const lines = text.split('\n');
    
    // الگوهای مختلف برای شناسایی کانفیگ‌ها
    const patterns = {
        vmess: /^vmess:\/\//,
        vless: /^vless:\/\//,
        trojan: /^trojan:\/\//
    };
    
    let currentConfig = null;
    
    lines.forEach(line => {
        line = line.trim();
        
        // شناسایی شروع یک کانفیگ جدید
        if (patterns.vmess.test(line) || patterns.vless.test(line) || patterns.trojan.test(line)) {
            if (currentConfig) {
                configs.push(currentConfig);
            }
            
            currentConfig = {
                link: line,
                protocol: line.split('://')[0],
                country: 'Unknown',
                ping: Math.floor(Math.random() * 200) + 50, // مقدار تصادفی برای نمونه
                speed: Math.floor(Math.random() * 80) + 20   // مقدار تصادفی برای نمونه
            };
        }
        // پردازش اطلاعات اضافی کانفیگ
        else if (currentConfig && line.includes(':')) {
            const [key, value] = line.split(':').map(item => item.trim());
            
            if (key === 'country') {
                currentConfig.country = value;
            }
            else if (key === 'provider') {
                currentConfig.provider = value;
            }
        }
    });
    
    // اضافه کردن آخرین کانفیگ
    if (currentConfig) {
        configs.push(currentConfig);
    }
    
    return configs;
}

// تغییر در تابع switchTab برای استفاده از تابع جدید
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    if (tab === 'telegram') {
        document.getElementById('telegramFilters').style.display = 'flex';
        document.getElementById('v2rayFilters').style.display = 'none';
        document.getElementById('proxyList').style.display = 'grid';
        document.getElementById('v2rayList').style.display = 'none';
    } else {
        document.getElementById('telegramFilters').style.display = 'none';
        document.getElementById('v2rayFilters').style.display = 'flex';
        document.getElementById('proxyList').style.display = 'none';
        document.getElementById('v2rayList').style.display = 'grid';
        
        // استفاده از تابع جدید برای دریافت کانفیگ‌ها
        if (v2rayConfigs.length === 0) {
            fetchRealV2RayConfigs();
        }
    }
}
